# Lean RAG Configuration for VeriPilot
# Phase 1a: Lean Knowledge Retrieval
#
# NOTE: dalek-verify-lean is EXCLUDED from RAG corpus - it's used for evaluation only.
# RAG corpus comes from public Lean 4 resources (mathlib4, books, projects).

# =============================================================================
# CORPUS SOURCES (Priority order from resources/Lean-RAG-Resources.md)
# =============================================================================
corpus:
  # Priority 1: Core libraries
  sources:
    - name: "mathlib4"
      type: "git"
      url: "https://github.com/leanprover-community/mathlib4.git"
      path: "data/sources/mathlib4"
      patterns: ["Mathlib/**/*.lean"]
      exclude: [".lake/**", "Archive/**", "Counterexamples/**"]
      # Sparse checkout folders (for lightweight extraction)
      sparse_checkout:
        - "Mathlib/Tactic/**"                      # Tactics - essential for proof automation
        - "Mathlib/Init/**"                        # Core lemmas (Nat.add_comm, etc.)
        - "Mathlib/Logic/**"                       # Basic logic
        - "Mathlib/Data/**"                        # Data structures
        - "Mathlib/Algebra/Group/**"               # Group theory
        - "Mathlib/Algebra/Ring/**"                # Ring theory
        - "Mathlib/Algebra/Field/**"               # Field theory
        - "Mathlib/LinearAlgebra/**"               # Linear algebra
        - "Mathlib/AlgebraicGeometry/EllipticCurve/**"  # Elliptic curves
      priority: 1
      description: "Core math library - 50K+ lemmas (selective folders)"

    - name: "lean4-stdlib"
      type: "git"
      url: "https://github.com/leanprover/lean4.git"
      path: "data/sources/lean4"
      patterns: ["src/Lean/**/*.lean", "src/Init/**/*.lean"]
      priority: 1
      description: "Lean 4 standard library"

    - name: "batteries"
      type: "git"
      url: "https://github.com/leanprover/std4.git"
      path: "data/sources/batteries"
      patterns: ["Std/**/*.lean"]
      priority: 1
      description: "Batteries (std4) - Data structures, List.map, HashMap, etc."

    - name: "aesop"
      type: "git"
      url: "https://github.com/leanprover-community/aesop.git"
      path: "data/sources/aesop"
      patterns: ["Aesop/**/*.lean"]
      priority: 1
      description: "Aesop proof automation - tactics and rule sets"

    # Priority 1: Tutorial Books (git repos with .lean source files)
    # These use either Verso MD format or traditional Lean comments for literate programming
    - name: "tpil4"
      type: "book"
      url: "https://github.com/leanprover/theorem_proving_in_lean4"
      path: "data/sources/books/tpil4"
      content_path: "book/TPiL"
      format: "verso"
      priority: 1
      description: "Theorem Proving in Lean 4 - 13 chapters (Verso format)"

    - name: "fp-lean"
      type: "book"
      url: "https://github.com/leanprover/fp-lean"
      path: "data/sources/books/fp-lean"
      content_path: "book/FPLean"
      format: "verso"
      priority: 1
      description: "Functional Programming in Lean - 16+ chapters (Verso format)"

    - name: "mil"
      type: "book"
      url: "https://github.com/leanprover-community/mathematics_in_lean"
      path: "data/sources/books/mil"
      content_path: "MIL"
      format: "traditional"
      priority: 1
      description: "Mathematics in Lean - 13 chapters, exercises (traditional format)"

    - name: "metaprogramming-book"
      type: "book"
      url: "https://github.com/leanprover-community/lean4-metaprogramming-book"
      path: "data/sources/books/metaprogramming-book"
      content_path: "lean/main"
      format: "traditional"
      priority: 1
      description: "Metaprogramming in Lean 4 - 10 chapters (traditional format)"

    # Priority 2: Reference PDFs (kept for future use, but books preferred)
    - name: "hitchhikers_guide"
      type: "pdf"
      url: "https://browncs1951x.github.io/static/files/hitchhikersguide.pdf"
      path: "data/sources/pdfs/hitchhikers_guide.pdf"
      priority: 2
      description: "Hitchhiker's Guide to Logical Verification"

    # Priority 2: Formalization projects
    - name: "sphere-eversion"
      type: "git"
      url: "https://github.com/leanprover-community/sphere-eversion.git"
      path: "data/sources/sphere-eversion"
      patterns: ["SphereEversion/**/*.lean"]
      priority: 2
      description: "Geometric topology - 10K lines, modern best practices"

    - name: "carleson"
      type: "git"
      url: "https://github.com/fpvandoorn/carleson.git"
      path: "data/sources/carleson"
      patterns: ["Carleson/**/*.lean"]
      priority: 3
      description: "Harmonic analysis - ongoing, advanced techniques"

  # EXCLUDED: Evaluation targets (no peeking!)
  exclude_repos:
    - "dalek-verify-lean"  # Lean evaluation corpus
    - "dalek-lite"         # Verus evaluation corpus

extraction:
  # LeanDojo settings for .lean files
  lean_dojo:
    cache_dir: "${LEAN_DOJO_CACHE_DIR}"
    num_procs: 4

  # PDF extraction settings
  pdf:
    extract_code_blocks: true
    chunk_size: 1000
    overlap: 200

  # Output files
  output_dir: "data/extracted"
  lean_corpus: "data/extracted/lean_corpus.json"
  pdf_corpus: "data/extracted/pdf_corpus.json"
  combined_corpus: "data/extracted/combined_corpus.json"

databases:
  duckdb:
    path: "${DUCKDB_PATH}"
    # Table name for declarations
    table: "lean_declarations"
    # Full-text search for BM25 (Level 2)
    fts_enabled: true

  qdrant:
    url: "${QDRANT_URL}"
    api_key: "${QDRANT_API_KEY}"
    collection_name: "lean_proofs"
    # Vector dimension must match embedding model
    vector_size: 384

  neo4j:
    uri: "${NEO4J_URI}"
    user: "${NEO4J_USER}"
    password: "${NEO4J_PASSWORD}"

embeddings:
  provider: "local"
  model: "${EMBEDDING_MODEL}"
  # Dimension depends on model (bge-small: 384, bge-base: 768, bge-m3: 1024)
  dimension: 384
  batch_size: 32

retrieval:
  # Cascading retrieval configuration
  cascade_levels:
    - name: "type_index"
      backend: "duckdb"
      timeout_ms: 100
      priority: 1
      description: "Exact name and signature matching"

    - name: "bm25"
      backend: "duckdb_fts"
      timeout_ms: 500
      priority: 2
      description: "DuckDB full-text search (BM25-style)"

    - name: "semantic"
      backend: "qdrant"
      timeout_ms: 2000
      priority: 3
      top_k: 10
      description: "Qdrant embedding similarity search"

    - name: "graph"
      backend: "neo4j"
      timeout_ms: 5000
      priority: 4
      max_depth: 3
      description: "Dependency and similarity traversal"

  aggregation:
    max_results: 6
    deduplicate: true
    ranking: "weighted_sum"
    # Weights for combining scores from different levels
    weights:
      type_index: 1.0
      bm25: 0.9
      semantic: 0.8
      graph: 0.7

# Validation queries for testing
validation:
  queries_file: "data/test_queries/lean_test_queries.yaml"
  # Target metrics
  targets:
    type_index_latency_ms: 100
    overall_latency_ms: 2000
    relevance_score: 0.8

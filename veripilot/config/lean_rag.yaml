# Lean RAG Configuration for VeriPilot
# Phase 1a: Lean Knowledge Retrieval

corpus:
  name: "dalek-verify-lean"
  # Path relative to VeriPilot root
  path: "../lean-projects/dalek-verify-lean"
  patterns:
    - "Curve25519Dalek/**/*.lean"
  exclude:
    - "ai-benchmark/**"
    - ".lake/**"

extraction:
  # LeanDojo settings
  cache_dir: "${LEAN_DOJO_CACHE_DIR}"
  num_procs: 4
  # Output file for extracted data
  output_file: "data/extracted/lean_corpus.json"

databases:
  duckdb:
    path: "${DUCKDB_PATH}"
    # Table name for declarations
    table: "lean_declarations"

  weaviate:
    url: "${WEAVIATE_URL}"
    api_key: "${WEAVIATE_API_KEY}"
    collections:
      proofs: "LeanProofs"
      tactics: "LeanTactics"
      goals: "LeanGoals"  # For intermediate proof states

  neo4j:
    uri: "${NEO4J_URI}"
    user: "${NEO4J_USER}"
    password: "${NEO4J_PASSWORD}"

embeddings:
  provider: "local"
  model: "${EMBEDDING_MODEL}"
  # Dimension depends on model (bge-small: 384, bge-base: 768, bge-m3: 1024)
  dimension: 384
  batch_size: 32

retrieval:
  # Cascading retrieval configuration
  cascade_levels:
    - name: "type_index"
      backend: "duckdb"
      timeout_ms: 100
      priority: 1
      description: "Exact name and signature matching"

    - name: "bm25"
      backend: "weaviate"
      timeout_ms: 500
      priority: 2
      description: "Keyword-based BM25 search"

    - name: "semantic"
      backend: "weaviate"
      timeout_ms: 2000
      priority: 3
      top_k: 10
      description: "Embedding similarity search"

    - name: "graph"
      backend: "neo4j"
      timeout_ms: 5000
      priority: 4
      max_depth: 3
      description: "Dependency and similarity traversal"

  aggregation:
    max_results: 6
    deduplicate: true
    ranking: "weighted_sum"
    # Weights for combining scores from different levels
    weights:
      type_index: 1.0
      bm25: 0.9
      semantic: 0.8
      graph: 0.7

# Validation queries for testing
validation:
  queries_file: "data/test_queries/lean_test_queries.yaml"
  # Target metrics
  targets:
    type_index_latency_ms: 100
    overall_latency_ms: 2000
    relevance_score: 0.8
